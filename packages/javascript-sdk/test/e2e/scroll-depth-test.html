<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scroll Depth Test Page</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .section {
            margin-bottom: 50px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .short-page {
            height: 300px;
        }
        
        .long-page {
            height: 3000px;
        }
        
        .very-short-page {
            height: 100px;
        }
        
        .marker {
            position: absolute;
            right: 10px;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .marker-25 { top: 25%; }
        .marker-50 { top: 50%; }
        .marker-75 { top: 75%; }
        .marker-90 { top: 90%; }
        
        #test-controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        button {
            margin: 5px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="test-controls">
        <h3>Scroll Depth Test Controls</h3>
        <button onclick="scrollDepthTest.testShortPage()">Test Short Page</button>
        <button onclick="scrollDepthTest.testLongPage()">Test Long Page</button>
        <button onclick="scrollDepthTest.testVeryShortPage()">Test Very Short Page</button>
        <button onclick="scrollDepthTest.sendManualEvent()">Send Manual Event</button>
        <div class="status" id="status">Ready for testing...</div>
    </div>

    <div class="content" id="main-content">
        <div class="section">
            <h1>Scroll Depth Testing Page</h1>
            <p>This page is used to test various scroll depth scenarios.</p>
            <p>Use the controls in the top-left corner to run different tests.</p>
        </div>
        
        <div class="section">
            <h2>Test Scenarios</h2>
            <ul>
                <li><strong>Short Page:</strong> Tests scroll depth 0 tracking</li>
                <li><strong>Long Page:</strong> Tests milestone tracking (25%, 50%, 75%, 90%)</li>
                <li><strong>Very Short Page:</strong> Tests edge case where content is shorter than viewport</li>
                <li><strong>Manual Event:</strong> Sends a manual scroll event to check current state</li>
            </ul>
        </div>
    </div>

    <!-- Scroll markers for long page -->
    <div class="marker marker-25">25%</div>
    <div class="marker marker-50">50%</div>
    <div class="marker marker-75">75%</div>
    <div class="marker marker-90">90%</div>

    <!-- Load Usermaven SDK -->
    <script type="text/javascript">     
        (function () {
            window.usermaven = window.usermaven || (function () { (window.usermavenQ = window.usermavenQ || []).push(arguments); })
            var t = document.createElement('script'),
                s = document.getElementsByTagName('script')[0];
            t.defer = true;
            t.id = 'um-tracker';
            t.setAttribute('data-tracking-host', "http://localhost:3000")
            t.setAttribute('data-key', 'UMTest123');
            t.setAttribute('data-autocapture', 'true');
            t.setAttribute('data-auto-pageview', 'false');  
            t.src = '/dist/lib.js';
            s.parentNode.insertBefore(t, s);
        })();
    </script>
    
    <script>

        // Wait for Usermaven to load and get scroll depth instance
        let scrollDepthInstance = null;
        let usermavenClient = null;
        
        function waitForUsermaven() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    // Get the script tag client instance
                    const client = window.usermavenScriptTagClient ? window.usermavenScriptTagClient() : null;
                    if (client && client.autoCapture && client.autoCapture.scrollDepth) {
                        usermavenClient = client;
                        scrollDepthInstance = client.autoCapture.scrollDepth;
                        clearInterval(checkInterval);
                        resolve(true);
                    }
                }, 100);
            });
        }
        
        // Test utilities
        window.scrollDepthTest = {
            currentScrollDepth: null,
            
            updateStatus: function(message) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = message;
                }
                console.log('ScrollDepthTest:', message);
            },
            
            testShortPage: function() {
                this.updateStatus('Testing short page (scroll depth 0)...');
                
                // Reset page to short content
                const content = document.getElementById('main-content');
                content.className = 'content short-page';
                content.style.height = '300px';
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                // Wait a bit then trigger scroll depth measurement and send event
                setTimeout(() => {
                    if (scrollDepthInstance) {
                        // Manually track current position (this updates maxScrollDepth)
                        scrollDepthInstance.track();
                        // Send the scroll event
                        scrollDepthInstance.send('$scroll');
                        this.updateStatus('Short page test completed - should send scroll depth 0');
                    } else {
                        this.updateStatus('Error: Scroll depth instance not available');
                    }
                }, 500);
            },
            
            testLongPage: function() {
                this.updateStatus('Testing long page (milestone tracking)...');
                
                // Set page to long content
                const content = document.getElementById('main-content');
                content.className = 'content long-page';
                content.style.height = '3000px';
                
                // Add more content for better testing
                const extraContent = document.createElement('div');
                extraContent.innerHTML = `
                    <div class="section"><h2>Section 1</h2><p>Content for 25% milestone...</p></div>
                    <div class="section"><h2>Section 2</h2><p>Content for 50% milestone...</p></div>
                    <div class="section"><h2>Section 3</h2><p>Content for 75% milestone...</p></div>
                    <div class="section"><h2>Section 4</h2><p>Content for 90% milestone...</p></div>
                    <div class="section"><h2>Final Section</h2><p>End of content...</p></div>
                `;
                content.appendChild(extraContent);
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                this.updateStatus('Long page setup completed - ready for milestone testing');
            },
            
            testVeryShortPage: function() {
                this.updateStatus('Testing very short page (shorter than viewport)...');
                
                // Set page to very short content
                const content = document.getElementById('main-content');
                content.className = 'content very-short-page';
                content.style.height = '100px';
                
                // Remove extra content
                const extraContent = content.querySelector('div:last-child');
                if (extraContent && extraContent.innerHTML.includes('Section 1')) {
                    content.removeChild(extraContent);
                }
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                this.updateStatus('Very short page test completed - should return 100% scroll depth');
            },
            
            simulateScroll: function(percentage) {
                const documentHeight = Math.max(
                    document.body.scrollHeight,
                    document.documentElement.scrollHeight
                );
                const windowHeight = window.innerHeight;
                const maxScroll = documentHeight - windowHeight;
                const targetScroll = (maxScroll * percentage) / 100;
                
                window.scrollTo(0, targetScroll);
                
                this.updateStatus(`Scrolled to ${percentage}% (${Math.round(targetScroll)}px)`);
                
                // Trigger scroll event manually if needed
                window.dispatchEvent(new Event('scroll'));
            },
            
            sendManualEvent: function() {
                this.updateStatus('Sending manual scroll event...');
                
                if (scrollDepthInstance) {
                    scrollDepthInstance.send('$scroll_manual');
                    this.updateStatus('Manual scroll event sent');
                } else {
                    this.updateStatus('Error: Scroll depth instance not available');
                }
            },
            
            getCurrentScrollDepth: function() {
                const windowHeight = window.innerHeight;
                const documentHeight = Math.max(
                    document.body.scrollHeight,
                    document.documentElement.scrollHeight
                );
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (documentHeight <= windowHeight) {
                    return 100;
                }
                
                const trackLength = documentHeight - windowHeight;
                const percent = Math.min(100, Math.max(0, Math.round((scrollTop / trackLength) * 100)));
                
                return percent;
            }
        };
        
        // Monitor scroll events for debugging
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const currentDepth = scrollDepthTest.getCurrentScrollDepth();
                scrollDepthTest.currentScrollDepth = currentDepth;
                console.log('Current scroll depth:', currentDepth + '%');
            }, 100);
        });
        
        // Initialize when Usermaven is ready
        waitForUsermaven().then(() => {
            scrollDepthTest.updateStatus('Usermaven loaded - ready for testing');
            
            // Expose for tests
            window.testResults = {
                scrollDepthLoaded: true,
                scrollDepthInstance: scrollDepthInstance,
                usermavenClient: usermavenClient,
                errors: []
            };
        });
        

        
        // Error handling
        window.addEventListener('error', function(e) {
            window.testResults.errors.push(e.message);
            console.error('Test error:', e);
        });
    </script>
</body>
</html>
